<!DOCTYPE html>
<html  onclick="volare('helicop')" onkeydown="volare('helicop')">
<head>
    <title>JoriCop</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">

 <link rel="stylesheet" href="style/human.css">
 <link rel="stylesheet" href="style/corda.css">
 <link rel="stylesheet" href="style/bird.css">

<style>


    /* per fer animacions mirar-se be al funció requestAnimationFrame() en comptes
    d'usar setTimeout() */
    
body{
    background-color:LightCyan;
    touch-action: manipulation;
}
html {
    touch-action: manipulation;
}

.heli {   
  position: absolute;
  top:200px;
  left:200px;
  width:50px;
  height: 25px;
  border-radius: 30px;
  background-color: DarkOliveGreen;
  color:white;
}
.cuah {   
  position:absolute;
  top:-12px;
  left:-7px;
  height: 25px;
  width:10px;
  border-radius: 30px;
  background-color: DarkOliveGreen;
  transform: rotate(-60deg);
  color:purple;
}
.helix2 {   
  position:absolute;
  top:-17px;
  left:-25px;
  height: 20px;
  width:20px;
  border-radius: 20px;
  background-color:silver;
}
.helix1 {   
  position:absolute;
  top:-30px;
  left:-15px;
  height: 15px;
  width:80px;
  border-radius: 50%;
  background-color:silver;
}
.cara {   
  position:absolute;
  transform: rotate(90deg);
  left:20px;
  top:5px;
}
.cara2 {   
  position:absolute;
  transform: rotate(0deg);
  left:20px;
  top:5px;
}
.cara3 {
     position:absolute;
  transform: rotate(90deg);
  left:5px;
}
.terra{
	background-color: gray;
}
.cel{
	background-color: blue;
}

#human1{
    position:absolute;
}

.boleta {
    position:absolute;
     width: 30px;
      height: 30px;
      border-radius: 30px;
      border-color: blue;
      background: greenyellow;
      
    }
.finestra {
    position:absolute;
     width: 30px;
      height: 30px;
     
      border-color: blue;
      background: greenyellow;
      
    }
#bloc1,#bloc2,#bloc3,#bloc4,#bloc5,#bloc6{
	position: absolute;
	height:200px;
	top:200px;
	left:150px;
}
#gameover{
	position:absolute;
	left:30%;
	top:30%;
	visibility:hidden;
	color:red;
}
#score{
    top:30px;
    left:30px;
    position:absolute;
}
#controls{
    position:absolute;
    visibility:hidden;
}

</style>
</head>
<body onload="carrega();">

<script src="js/rect.js"></script>
<script src="js/rectvol.js"></script>
<script src="js/randbolet2.js"></script>
<script src="js/underscore.js"></script>
<script>


var angcord=0; //angle inicial de la corda respecte la vertical
var rescats=0;
var rescatat=false;
let request; //aquesta variable serveix per fer les animacions
var xocat=false;
/*helicopter position & speed*/
// 					left,top,width,height,vx,vy
heli = new rectvol();
enemic1 = new rectvol();
human = new rectvol();
corda = new rectvol();
/*bloc position & speed*/
// 					left, top,width,height,vx,vy
bc1 = new rectvol();
bc2 = new rectvol();
bc3 = new rectvol();
bc4 = new rectvol();
bc5 = new rectvol();
bc6 = new rectvol();

var nomsb = ["bloc1","bloc2","bloc3","bloc4","bloc5","bloc6"];
var bloc = [bc1,bc2,bc3,bc4,bc5,bc6];

var mou=false;
var  sco=0;

function restart() {
    if(xocat) {
	 //reinicialitzant les coordenades de l'helicopter i els blocs:
	bc1.x=200; bc1.y= 200+Math.random()*300;
	bc2.x=400; bc2.y= 200+Math.random()*300;
	bc3.x=600; bc3.y= 200+Math.random()*300;
	bc4.x=800; bc4.y= 200+Math.random()*300;
	bc5.x=1000; bc5.y= 200+Math.random()*300;
	bc6.x=1200; bc6.y= 200+Math.random()*300;
        
        //reinicialitzant les coordenadees i velocitat del jjjjjjoricopter
	heli.x = 200; heli.y=bc1.y - 30; heli.vx=0; heli.vy=0;
	 //inicilitzant enemic1
        enemic1.x = 1200; enemic1.y=Math.random()*400; enemic1.vx=-10; enemic1.vy=0;
	
       
	mou=false;
	sco=0;
        rescats=0;
	document.getElementById("gameover").style.visibility="hidden"; //amaga el botó restart
        var n = bloc.length;
        for(var i=0;i<n;i++){
                    document.getElementById(nomsb[i]).style.backgroundColor ="gray";			
            }
        xocat=false;
        document.getElementById("cara").innerHTML=":O";
        mou=true;
	requestAnimationFrame(move);
    }
}

function carrega() {
	document.getElementById("aux2").innerHTML="carregant...";
	//reinitializing helicopter
	heli.width = 50; heli.height = 25; heli.x = 200; heli.y=300; heli.vx=0; heli.vy=0; heli.ay=0.2;
        //inicilitzant enemic1
        enemic1.width = 50; enemic1.height = 25; enemic1.x = 1200; enemic1.y=200; enemic1.vx=-10; enemic1.vy=0; enemic1.ay=0;
	
        //reinitializing the blocs
	bc1.width = 100; bc1.height = 400; bc1.x=200; bc1.y= heli.y+30; bc1.vx=-5; bc1.vy=0;
	bc2.width = 100; bc2.height = 400; bc2.x=400; bc2.y= 400+Math.random()*100; bc2.vx=-5; bc2.vy=0;
	bc3.width = 100; bc3.height = 400; bc3.x=600; bc3.y= 400+Math.random()*100; bc3.vx=-5; bc3.vy=0;
	bc4.width = 100; bc4.height = 400; bc4.x=800; bc4.y= 400+Math.random()*100; bc4.vx=-5; bc4.vy=0;
	bc5.width = 100; bc5.height = 400; bc5.x=1000; bc5.y= 400+Math.random()*100; bc5.vx=-5; bc5.vy=0;
	bc6.width = 100; bc6.height = 400; bc6.x=1200; bc6.y= 400+Math.random()*100; bc6.vx=-5; bc6.vy=0;
	
        human.x = bc6.x; human.y=bc6.y - 47; human.width=30; human.height=80;
        
        corda.x=23; corda.y = 23; corda.width=5; corda.height=100;
        
        draw();
	document.getElementById("aux2").innerHTML="hola2";
        document.getElementById("cara").innerHTML=":D";
        randbolet2(id="fons_de_pant",colors=["white","pink"],boles=80,spready=500,spreadx=1000,minballr=10,maxballr=100);
        var n = bloc.length;
        for(var i=0;i<n;i++){
                    //randbolet2(id=nomsb[i],colors=["LightCyan","brown","gray"],boles=10,spready=400,spreadx=100,minballr=20,maxballr=40);			
                    randquadrats(id=nomsb[i],colors=["LightCyan","#bf7873","#e9b088","greenyellow"],fileshor=4,filesver=13,height=400,width=100,border=3);

            }
     
         intro();
}

function caratrista() {
    document.getElementById("cara").innerHTML=":(";
}

function intro() {
  
            document.getElementById("score").innerHTML="<p align='justify'><b>A long time in the future, in a faraway land.. an office worker is stuck in her office. She is just tired of working and just wants to get out" +
                    " and scream ALELUYA! with all her might. However, she is stuck in the office. But her employer came to the office by Copter today! So she decides to take the chance and sneak into her" +
                    " employer copter and take a ride around da city! Will you have what it takes to master the mystery of flight and take a fly around the sky-scrappers? Now is your chance!!!<b> <br> "+
                    "</p><center><button onclick='mou=true;requestAnimationFrame(move)'><h1><b style='color:red'>YES</b></h1></button>"+
                    "<button onclick='caratrista()'><h1><b style='color:blue'>NO<b></h1></button></center>"; 
}

function move() {
	//check hit:
	if( checkxoc(heli,bc1) || checkxoc(heli,bc2) || checkxoc(heli,bc3) || checkxoc(heli,bc4) || checkxoc(heli,bc5) || checkxoc(heli,bc6) || 
                checkxoc(heli,enemic1)  )  {
		gameover();
		return;
	}
        //check resque:
        if(  !rescatat && ( checkxoc(heli,human)  ||  
                                                abovesegment( [heli.x+corda.x - corda.height*Math.sin(Math.PI*angcord/180), heli.y+heli.height+corda.y+Math.cos(Math.PI*angcord/180)*corda.height],
                                                                [heli.x+corda.x,  heli.y+heli.height+corda.y],
                                                                [human.x,human.y], human, ab=false)
                                                 ) ) {
            rescats += 1;
            rescatat=true;
            document.getElementById("human1").style.visibility="hidden";
        }
        if(human.x + human.width < heli.x)
        {
            document.getElementById("cara_huma").innerHTML=":o";
        } else
        {
            document.getElementById("cara_huma").innerHTML=":)";
        }
	//move
        
        if(mou) {
		moveheli(heli);
		moveheli(enemic1);
		var n = bloc.length;
		for(var i=0;i<n;i++) {
			movebloc(bloc[i],i);
		}
                movehuman(human);
                angcord = angcord + Math.random()*4 - 2;
                if(angcord<0) angcord=0.01; if(angcord>40) angcord=40;
                document.getElementById("corda").style.transform="rotate("+ angcord +"deg)";
	}
		
		
	
	/*draw helicop and bloc*/
	draw();
	
	/*texts auxiliars*/
	document.getElementById("aux2").innerHTML = "windown inner width: "+ window.innerWidth + " window.innerHeight: "+window.innerHeight +
                "<br> segment ["+Math.round(heli.x+corda.x - corda.height*Math.sin(Math.PI*angcord/180))+","+ Math.round(heli.y+heli.height+corda.y+Math.cos(Math.PI*angcord/180)*corda.height)+"], ["+ 
                                                                Math.round( heli.x+corda.x )+", "+ Math.round(heli.y+heli.height+corda.y )+"],["+
                                                                Math.round(human.x)+","+Math.round(human.y)+"]: "+abovesegment([heli.x+corda.x - corda.height*Math.sin(Math.PI*angcord/180), heli.y+heli.height+corda.y+Math.cos(Math.PI*angcord/180)*corda.height],
                                                                [heli.x+corda.x,  heli.y+heli.height+corda.y],
                                                                [human.x,human.y],false);
	document.getElementById("aux1").innerHTML="heli vy:" +Math.round(heli.vy) + "<br> heli y:" + Math.round(heli.y) +
                 "<br> heli height: " +Math.round(heli.height) + "<br> heli x: " + heli.x +
	 "<br>bloc vx:" +Math.round(bc1.vx) + "<br>pos x bloc:" +Math.round(bc1.x) +
	"<br> bloc vy: " +Math.round(bc1.vy) + "<br> bloc y: " + Math.round(bc1.y) + "<br> enemic1 y: " + Math.round(enemic1.y) +
        "<br> enemic1 x: " + Math.round(enemic1.x) + "<br> request: " + request +
         "<br> human x: " + human.x + "<br> human y: " + human.y + "<br> human heigth: " + human.height + "<br> human width " + human.width +
         "<br> bloc 6 y " + bc6.y + "<br> corda*sin(ang corda):"+ Math.round(corda.height*Math.sin(Math.PI*angcord/180) ) + 
          "<br> angle corda: " + angcord ;
	
	document.getElementById("score").innerHTML = "<h3><b>Distance <b style='color:brown'>"+Math.round(sco/10)/100 +" </b></b>km  - clerks resqued </b><b style='color:brown'>"+rescats+"</b></h3>";
	if(mou) sco +=1;
	
        if( (sco % 400) ===0) {enemic1.x=1200; enemic1.vx=-10; enemic1.y=Math.random()*bc1.y    ;}
        
	if(sco>1000) {
		var n = bloc.length;
		for(var i=0;i<n;i++){
			document.getElementById(nomsb[i]).style.backgroundColor ="DarkSlateBlue";			
		}
		if(sco>2000) {
			var n = bloc.length;
			for(var i=0;i<n;i++){
				document.getElementById(nomsb[i]).style.backgroundColor ="darkgreen";			
			}
		}
                
	}
        if(heli.y>enemic1.y) {
                    enemic1.vy = 3} else {enemic1.vy=-3}
	
	//repeat
	request = requestAnimationFrame(move); 
}

function draw() {
    //draw helicopter
	document.getElementById("helicop").style.top=heli.y+"px";
	document.getElementById("helicop").style.left=heli.x+"px";
	document.getElementById("helicop").style.width=heli.width+"px";
	document.getElementById("helicop").style.height=heli.height+"px";
       //draw eemy helicopter
        document.getElementById("enemic1").style.top=enemic1.y+"px";
	document.getElementById("enemic1").style.left=enemic1.x+"px";
	document.getElementById("enemic1").style.width=enemic1.width+"px";
	document.getElementById("enemic1").style.height=enemic1.height+"px";
        
       	document.getElementById("human1").style.top=human.y+"px";
        document.getElementById("human1").style.left=human.x+"px";
        
        document.getElementById("corda").style.top=corda.y+"px";
	document.getElementById("corda").style.left=corda.x+"px";
	document.getElementById("corda").style.width=corda.width+"px";
	document.getElementById("corda").style.height=corda.height+"px";

	var n = nomsb.length;
	for(var i=0;i<n;i++){
	
		document.getElementById(nomsb[i]).style.top=bloc[i].y+"px";
		document.getElementById(nomsb[i]).style.left=bloc[i].x+"px";
		document.getElementById(nomsb[i]).style.width=bloc[i].width+"px";
		document.getElementById(nomsb[i]).style.height=bloc[i].height+"px";
	}
	
}

function checkxoc(rect1, rect2) {
   if(rect1.x < rect2.x + rect2.width &&
      rect1.x + rect1.width > rect2.x &&
      rect1.y < rect2.y + rect2.height &&
      rect1.y + rect1.height > rect2.y) 
   {
       return true;
   }
   return false;
}

function abovesegment(p1,p2,p3, obj1, ab=true) {
    //p1 and p2 are the two limit points of the segment. p3 is the point we want to check whether
    // it is above (ab=true) or below (ab=false) of the segment p1p2
    //p2.x must be > p1.x
    var m = (p2[1]-p1[1])/(p2[0]-p1[0]);
    var n = p2[1]- m*p2[0];
    quad1 = new rect(p1[0],p2[1], Math.abs(p2[0]-p1[0]), Math.abs(p2[1]-p1[1]));
    if(!checkxoc(quad1,obj1)) return false; //checking that the x + width segment intersects the p1.x, p2.x segmetn
    if(ab) return (p3[1] >= m*p3[0] + n);
    return (p3[1] <= m*p3[0] + n);
}

function moveheli(rectvol){
	rectvol.vy=rectvol.vy+=rectvol.ay;
	rectvol.y = rectvol.y+rectvol.vy;
        rectvol.x = rectvol.x+rectvol.vx;
        
        /*check speed limits*/
	if(rectvol.vy>20) rectvol.vy=20;
	if(rectvol.vy<-20) rectvol.vy= -20;
	
	/*check height limits*/
	if(rectvol.y>600) { 
		rectvol.y=600;
		rectvol.vy = 0;
	}
	if(rectvol.y<0) {
		rectvol.y=0;
		rectvol.vy = 0;
	}
        //the next if is to stop the red helicopters from going too far out of the screen
        if(rectvol.x<-100) {
		rectvol.x=-100;
		rectvol.vx = 0;
	}
}

function movebloc(rect, i){
	if(i===0) { 
            i = bloc.length-1;
	} else {
            i=i-1;
        }
        
	rect.x = rect.x + rect.vx;
	if(rect.x < -rect.width) {
		rect.x = 1100 ;
		rect.y = bloc[i].y +  Math.floor(Math.random() * (150)-75 );
		if(rect.y<200) rect.y=200;
		if(rect.y>450) rect.y=450;
                if(i===5 && rescatat) {
                    rescatat=false;
                    document.getElementById("human1").style.visibility="visible";
                }
	}
	
}
function movehuman() {
    human.x = bc6.x; human.y = bc6.y-47;
}
function volare(id) {
        if(mou) { 
	 heli.vy = heli.vy - 6;
	 heli.y += heli.vy;	 
     }
}

function gameover() {
    xocat=true;
    document.getElementById("gameover").style.visibility="visible";  
    document.getElementById("cara").innerHTML=":X";  
}

</script>
<div id="fons_de_pant"> </div>

<div class="flock">
<div class="bird"  style="background-color:black;top:210px;left:40px">
    <div class="wing wing1"  style="left:-5px;"></div>
    <div class="wing wing2"  style="left:5px;"></div>
</div>
 <div class="bird" id="bird2" style="background-color:brown;top:220px;left:20px;;">
    <div class="wing wing1"  style="background-color:brown;left:-5px;"></div>
    <div class="wing wing2"  style="background-color:brown;left:5px;"></div>
</div>
<div class="bird"  style="background-color:blue;top:230px;">
    <div class="wing wing1"  style="background-color:blue;left:-5px;"></div>
    <div class="wing wing2"  style="background-color:blue;left:5px;"></div>
</div>
</div>

<div class="flock">
<div class="bird"  style="background-color:black;top:210px;left:40px">
    <div class="wing wing1"  style="left:-5px;"></div>
    <div class="wing wing2"  style="left:5px;"></div>
</div>
 <div class="bird" id="bird2" style="background-color:brown;top:220px;left:20px;;">
    <div class="wing wing1"  style="background-color:brown;left:-5px;"></div>
    <div class="wing wing2"  style="background-color:brown;left:5px;"></div>
</div>
<div class="bird"  style="background-color:blue;top:230px;">
    <div class="wing wing1"  style="background-color:blue;left:-5px;"></div>
    <div class="wing wing2"  style="background-color:blue;left:5px;"></div>
</div>
</div>

<div class="terra" id="bloc1"></div>
<div class="terra" id="bloc2"></div>
<div class="terra" id="bloc3"></div>
<div class="terra" id="bloc4"></div>
<div class="terra" id="bloc5"></div>
<div class="terra" id="bloc6"></div>


<div id="enemic1" class="heli" style="left:100px;background-color:red;transform: rotateY(180deg);" >
    <div class="helix1"></div>
    <div class="helix2"></div>
    <div class="cuah" style="background-color:red;"></div>
    <div class="cara2"> o.O </div>
</div>


<div id="human1"><span class="leg1"></span><span class="leg2"></span><span class="arms"></span><span class="body"></span><span class="head"><span class="cara3" id="cara_huma">:|</span></span></div>

<div id="helicop" class="heli">
    <div class="helix1"></div>
    <div class="helix2"></div>
    <div class="cuah"></div>
    <div class="cara" id="cara">:d</div>   
    <div id="corda"> </div>
</div>
        

<div id="gameover"> 
	<h2><b>GAME OVER</b></h2>
        <center><button id="botogameov" style ="color:blue" onclick="restart()"><h2><b>restart</b></h2></button></center>
</div> 
<div id="score"></div>
<div id="controls">
<p id="aux1"></p>
<p id="aux2"></p>

</div>
</body  >
</html> 
