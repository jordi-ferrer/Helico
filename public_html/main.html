<!DOCTYPE html>
<html  onclick="volare('helicop')" onkeydown="volare('helicop')">
<head>
<title>JoriCop</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
<meta charset="UTF-8">
<meta http-equiv="Content-type" content="text/html; charset=UTF-8">

<link rel="stylesheet" href="style/human.css">
<link rel="stylesheet" href="style/heli.css">
<link rel="stylesheet" href="style/corda.css">
<link rel="stylesheet" href="style/buildings.css">
<link rel="stylesheet" href="style/bird.css">
<link rel="stylesheet" href="style/cel.css">
<link rel="stylesheet" href="style/button.css">
<link rel="stylesheet" href="style/flag.css">
<link rel="stylesheet" href="style/controls.css">
<link rel="stylesheet" href="style/forms.css">
<link rel="stylesheet" href="style/chair.css">
<link rel="stylesheet" href="style/intro_gameover.css">

<style>

/* per fer animacions mirar-se be al funció requestAnimationFrame() en comptes
d'usar setTimeout() */

body{
    background-color:LightCyan;
    touch-action: manipulation;
}
html {
    touch-action: manipulation;
}

#score{
    top:30px;
    left:30px;
    position:absolute;
}
#controls{
    position:absolute;
    visibility:hidden;
}

</style>
</head>
<body onload="carrega();">

<script src="js/class/rect.js"></script>
<script src="js/class/rectvol.js"></script>
<script src="js/class/person.js"></script>
<script src="js/class/edifici.js"></script>
<script src="js/class/heli.js"></script>
<script src="js/class/corda.js"></script>
<script src="js/class/bandera.js"></script>
<script src="js/class/chair.js"></script>

<script src="js/function/randbolet2.js"></script>
<script src="js/function/underscore.js"></script>
<script src="js/function/movement.js"></script>
<script src="js/function/xocs.js"></script>
<script src="js/function/introanimation.js"></script>
<script src="js/function/songs.js"></script>
<script src="js/function/gameover.js"></script>


<script>

var mou = false;
var sco = 0;
var skipintro = false;
var rescats = 0;
var rescatat = false;
let request; //aquesta variable serveix per fer les animacions
var xocat = false;
var checkpoint = 1;
var current_checkpoint = 0;
const checkpoint_dist = 1000;

/*helicopter position, speed & rope*/
//                  left,top,width,height,vx,vy,ax,ay,name
heli = new helicop(200, 300, 50, 25, 0, 0, 0, 0.2,0,0,0, "helicop");
//parts de l'helicopter
helix1 = new rectvol(0, 0, 80, 15, 0, 0, 0, 0, 0,0,0, "helix1");
helix2 = new rectvol(0,0, 20, 20, 0, 0, 0, 0, 0,0,0, "helix2");
cuah = new rectvol(-2, 0, 10, 25, 0, 0, 0, 0, -60,0,0, "cuah");
cosheli = new rectvol(0, 0, 50, 25, 0, 0, 0, 0, 0,0,0, "cosheli");


helix1_cp = new rectvol();  helix1_cp.naiveCopy(helix1);
helix2_cp = new rectvol();  helix2_cp.naiveCopy(helix2);
cuah_cp = new rectvol();    cuah_cp.naiveCopy(cuah);
cosheli_cp = new rectvol(); cosheli_cp.naiveCopy(cosheli);

orig_helix1 = 
  

corda = new rope(heli.x + heli.width/4,heli.y + heli.height - 8, 5, 100, 0,0, 0, 0,0,0,0, "corda","segment1","segment2","segment3");


enemic1 = new helicop(1200, 200, 50, 25, -10, 0, 0, 0,0,0,0, "enemic1");
        
/*bloc position & speed*/
bc1 = new edifici(200, heli.y+30, 100, 400, -5, 0, 0, 0,0,0,0, "bloc1");
bc2 = new edifici(400, 400+Math.random()*100, 100, 400, -5, 0, 0, 0,0,0,0, "bloc2");
bc3 = new edifici(600, 400+Math.random()*100, 100, 400, -5, 0, 0, 0,0,0,0, "bloc3");
bc4 = new edifici(800, 400+Math.random()*100, 100, 400, -5, 0, 0, 0,0,0,0, "bloc4");
bc5 = new edifici(1000, 400+Math.random()*100, 100, 400, -5, 0, 0, 0,0,0,0, "bloc5");
bc6 = new edifici(1200, 400+Math.random()*100, 100, 400, -5, 0, 0, 0,0,0,0, "bloc6");

var bloc = [bc1,bc2,bc3,bc4,bc5,bc6];

human = new person(bc6.x, bc6.y - 58, 10, 65, 0, 0, 0, 0,0,0,0, "human1", "cara_huma");
montse = new person(bc1.x+1.5*heli.width, bc1.y + 58, 50, 65, 0, 0, 0, 0,0,0,0, "human2", "cara_montse");
jefe = new person(bc1.x+1.5*heli.width, bc1.y + 58, 50, 65, 0, 0, 0, 0,0,0,0, "jefe", "cara_jefe");

/*flag*/
flag = new bandera(bc6.x, bc6.y-58, 33, 50, 0, 0, 0, 0,0,0,0, "flag");

chair = new chair(bc3.x, bc3.y - 53, 25, 53,0, 0, 0, 0,0,0,0, "officechair");

// checkpoint stored variables
var sco_cp;
var rescats_cp;
bc1_cp = new edifici();
bc2_cp = new edifici();
bc3_cp = new edifici();
bc4_cp = new edifici();
bc5_cp = new edifici();
bc6_cp = new edifici();
flag_cp = new bandera();
human_cp = new person();
heli_cp = new helicop();
enemic_cp = new helicop();

function restart() {
    if(xocat) {
        if( current_checkpoint > 0) //checkpoint guardat
        {
            sco = sco_cp;
            rescats = rescats_cp;
            
            bc1.naiveCopy(bc1_cp);
            bc2.naiveCopy(bc2_cp);
            bc3.naiveCopy(bc3_cp);
            bc4.naiveCopy(bc4_cp);
            bc5.naiveCopy(bc5_cp);
            bc6.naiveCopy(bc6_cp);
            flag.naiveCopy(flag_cp);
            human.naiveCopy(human_cp);
            heli.naiveCopy(heli_cp);
            heli.vx=0; heli.vy=0;
            enemic1.naiveCopy(enemic_cp);
            
            flag.setBanner(2);
            flag.show();
        }
        else //no checkpoint
        {
            sco=0;
            rescats=0;
            //flag.show();
            //reinicialitzant les coordenades de l'helicopter i els blocs:
            bc1.x=200; bc1.y= 200+Math.random()*300;
            bc2.x=400; bc2.y= 200+Math.random()*300;
            bc3.x=600; bc3.y= 200+Math.random()*300;
            bc4.x=800; bc4.y= 200+Math.random()*300;
            bc5.x=1000; bc5.y= 200+Math.random()*300;
            bc6.x=1200; bc6.y= 200+Math.random()*300;
            bloc.forEach(element => element.setColour("gray"));

            //reinicialitzant les coordenadees i velocitat del jjjjjjoricopter
            heli.x = 200; heli.y = bc1.y - heli.width; heli.vx=0; heli.vy=0;
            
            //inicilitzant enemic1
            enemic1.x = 1200; enemic1.y=Math.random()*400; enemic1.vx=-10; enemic1.vy=0;
        }
        corda.x = heli.x +23; corda.y = heli.y + 23;
        
        helix1.naiveCopy(helix1_cp);
        helix2.naiveCopy(helix2_cp);
        cuah.naiveCopy(cuah_cp);
        cosheli.naiveCopy(cosheli_cp);

        corda.ang = 0;//modificar
	//mou=false;
	document.getElementById("gameover").style.visibility="hidden"; //amaga el botó restart
        
        //erase submit form:
        document.getElementById("formsendsc").style.visibility="hidden";
        document.getElementById("user").value="";
        document.getElementById("email").value="";
        document.getElementById("comment").value="";
        document.getElementById("distance").value=0;
        document.getElementById("clerks").value=0;

        xocat = false;
        heli.setCara(":O");
        //mou = true;
	requestAnimationFrame(move);
    }
}

function carrega() {
        setwidths();
	//document.getElementById("aux2").innerHTML="carregant...";
        draw();
	//document.getElementById("aux2").innerHTML="hola2 " + corda.angle;
        heli.setCara(":D");
        randbolet2(id="fons_de_pant",colors=["white","pink"],boles=80,spready=500,spreadx=1000,minballr=10,maxballr=100);
        bloc.forEach(element => element.createWindows());
        
        intro();
}


function move() {
    //check hit:
    if( checkxoc(heli,bc1) || checkxoc(heli,bc2) || checkxoc(heli,bc3) || checkxoc(heli,bc4) || checkxoc(heli,bc5) || checkxoc(heli,bc6) || 
        checkxoc(heli,enemic1) )  {
        gameover();
        return;
    }

    //check resque:
    if( !rescatat && ( checkxoc(heli,human) || xocrotatedrect(corda,human) )) {
        rescats += 1;
        rescatat = true;
        human.hide();
    }
    //checkpoint
    if(checkxoc(heli,flag) && flag.isVisible())
    {
        flag.setBanner(2);
        flag.show();

        // saving checkpoint state
        current_checkpoint = checkpoint;
        sco_cp = sco;
        rescats_cp = rescats;
        bc1_cp.naiveCopy(bc1);
        bc2_cp.naiveCopy(bc2);
        bc3_cp.naiveCopy(bc3);
        bc4_cp.naiveCopy(bc4);
        bc5_cp.naiveCopy(bc5);
        bc6_cp.naiveCopy(bc6);
        flag_cp.naiveCopy(flag);
        human_cp.naiveCopy(human);
        heli_cp.naiveCopy(heli);
        enemic_cp.naiveCopy(enemic1);
    }
    //si no rescata a un clerck posa cara de sorpresa:
    if(human.x + human.width < heli.x) {
        human.setCara(":o");
    } else {
        human.setCara(":)");
    }

    //move
    if(mou) {
        heli.move();
        enemic1.move();
        bloc.forEach(movebloc);
        human.move(bc6);
        flag.move();
        corda.move();
        
        chair.move(bc3, chair.height);
    }

    if(sco > checkpoint*checkpoint_dist)
    {
        checkpoint++;
        var ind = 0;
        var i;
        for (i = 1; i < 6; i++) {
            if(bloc[i].x > bloc[ind].x)
            {
                ind = i;
            }
        }
        flag.index = ind;
        flag.show();
    }
    if(flag.x < -30)
    {
        flag.setBanner(1);
        flag.hide();
    }

    /*draw helicop and bloc*/
    draw();

    /*texts auxiliars*/
    if(document.getElementById("controls").style.visible==="visible")
    {
        document.getElementById("aux2").innerHTML = "windown inner width: " + window.innerWidth + " window.innerHeight: " + window.innerHeight ;
        document.getElementById("aux1").innerHTML="heli vy:" + Math.round(heli.vy) + "<br> heli y:" + Math.round(heli.y) +
        "<br> heli height: " + Math.round(heli.height) + "<br> heli x: " + heli.x +
        "<br>bloc vx:" + Math.round(bc1.vx) + "<br>pos x bloc:" + Math.round(bc1.x) +
        "<br> bloc vy: " + Math.round(bc1.vy) + "<br> bloc y: " + Math.round(bc1.y) + "<br> enemic1 y: " + Math.round(enemic1.y) +
        "<br> enemic1 x: " + Math.round(enemic1.x) + "<br> request: " + request +
        "<br> human x: " + human.x + "<br> human y: " + human.y + "<br> human heigth: " + human.height + "<br> human width " + human.width +
        "<br> bloc 6 y " + bc6.y + "<br> corda*sin(ang corda):" + Math.round(corda.height*Math.sin(Math.PI*corda.ang/180) ) + 
        "<br> angle corda: " + corda.ang ;
    }
    document.getElementById("score").innerHTML = "<h3 style='color:white;text-shadow:1px 1px 4px blue;' ><b>Distance <b style='color:brown;'>"+Math.round(sco/10)/100 +" </b></b>km  - Clerks resqued </b><b style='color:brown'>"+rescats+"</b></h3>";
    if(mou) sco +=1;

    if( (sco % 400) === 0) {
        enemic1.x = 1200;
        enemic1.y = Math.random()*bc1.y;
        enemic1.vx = -10;
    }

    if(sco > 1000) {
        bloc.forEach(element => element.setColour("DarkSlateBlue"));
        if(sco > 2000) {
            bloc.forEach(element => element.setColour("darkgreen"));
        }
    }

    if(heli.y > enemic1.y) {
        enemic1.vy = 3;
    } else {
        enemic1.vy=-3;
    }

    //repeat
    request = requestAnimationFrame(move); 
}


function setwidths() {
    heli.setwidths();
    helix1.setwidths();
    helix2.setwidths();
    cuah.setwidths();
    cosheli.setwidths();
    
    enemic1.setwidths();
    human.setwidths();
    
    chair.setwidths();
    
    corda.setwidths();
    flag.setwidths();
    bloc.forEach(element => element.setwidths());
}

function draw() {
    heli.draw();  
    helix1.draw();
    helix2.draw();
    cuah.draw();
    cosheli.draw();
    
    enemic1.draw("rotateY(180deg)");//afegeixo una transformacio al elicopter enemic
    human.draw();
    
    chair.draw();
    
    corda.draw();
    flag.draw();
    bloc.forEach(element => element.draw()); //wow què és això? de:Romà
}





function showranking() {
    window.location.href = "php/getusers.php";
}


</script>
<div class="solbunch">
<div class="aura1"></div>
<div class="aura2"></div>
<div class="sol"> </div>
</div>
    
<div id="fons_de_pant"></div>

<div class="flock">
    <div class="bird"  style="background-color:Coral;top:210px;left:40px">
        <div class="wing wing1"  style="left:-5px;"></div>
        <div class="wing wing2"  style="left:5px;"></div>
    </div>
    <div class="bird" id="bird2" style="background-color:CadetBlue;top:220px;left:20px;">
       <div class="wing wing1"  style="background-color:CadetBlue;left:-5px;"></div>
       <div class="wing wing2"  style="background-color:CadetBlue;left:5px;"></div>
    </div>
    <div class="bird"  style="background-color:black;top:230px;">
        <div class="wing wing1"  style="background-color:CadetBlue;left:-5px;"></div>
        <div class="wing wing2"  style="background-color:CadetBlue;left:5px;"></div>
    </div>
</div>

<div class="flock" style="top:-110px;left:240px">
    <div class="bird"  style="background-color:Crimson;top:210px;left:40px">
        <div class="wing wing1"  style="left:-5px;"></div>
        <div class="wing wing2"  style="left:5px;"></div>
    </div>
    <div class="bird" id="bird2" style="background-color:Crimson;top:220px;left:20px;">
       <div class="wing wing1"  style="background-color:brown;left:-5px;"></div>
       <div class="wing wing2"  style="background-color:brown;left:5px;"></div>
   </div>
   <div class="bird"  style="background-color:DarkCyan;top:230px;">
       <div class="wing wing1"  style="background-color:Coral;left:-5px;"></div>
       <div class="wing wing2"  style="background-color:Coral;left:5px;"></div>
   </div>
</div>

<div id="areavital" ><div id="human2"><span class="peluca"></span><span class="leg1m"></span><span class="leg2m"></span><span class="armsm"></span><span class="bodym"></span><span class="headm"><span class="cara3" id="cara_montse">:|</span></span></div>
</div>

<div id="areavital2" ><div id="jefe"><span class="peluca2"></span><span class="leg13"></span><span class="leg23"></span><span class="arms3"></span><span class="body3"><span class="papada2"></span><span class="panxa2"></span><span class="head3"><span class="cara4" id="cara_jefe">;}</span></span></div>
</div>

<div class="terra" id="bloc1"></div>
<div class="terra" id="bloc2"></div>
<div class="terra" id="bloc3"></div>
<div class="terra" id="bloc4"></div>
<div class="terra" id="bloc5"></div>
<div class="terra" id="bloc6"></div>

<div id="enemic1" class="heli" style="background-color:red;" >
    <div class="helix1"></div>
    <div class="helix2"></div>
    <div class="cuah" style="background-color:red;"></div>
    <div class="cara2">o.O</div>
</div>

 <div id="human1"><span class="leg1"></span><span class="leg2"></span><span class="arms"></span><span class="body"><span class="papada"></span><span class="panxa"></span></span><span class="head"><span class="cara3" id="cara_huma">:|</span></span></div>


<div id="flag">
    <span class="stick"></span>
    <span class="banner1" id="banner1"></span>
    <span class="banner2" id="banner2"></span>
</div>

<div id="officechair"></div>


<div id="helicop" class="heli">
    <div id="cosheli" class="cosheli">
        <div class="cara" id="cara">:D</div>  
    </div>
    <div id="helix1" class="helix1"></div>
    <div id="helix2" class="helix2"></div>
    <div id="cuah" class="cuah"></div>
     
</div>

<div id="corda">
    <span class="segment1" id="segment1"></span>
    <span class="segment2" id="segment2"></span>
    <span class="segment3" id="segment3"></span>
</div>

<div id="score"></div>

<div id="controls">
    <p id="aux1"></p>
    <p id="aux2"></p>
    <p id="aux3"></p>
</div>
<br>
<br>
<br>
<div id="formsendsc"> <h2><i>Send score to da server, sist! </i></h2>
    <form action="php/sendscore.php" >
        <input placeholder="your name" name="user" id="user"> 
        <input placeholder="email" name="email" id="email">
        <p>Comments for the creators Jordi and Romà:</p>
        <textarea id="comment" placeholder="Your comments on the game" name="comentaris" rows="8" cols="40"></textarea>
        <br>
        <input class ="submitbut" type="submit" value="Send score! :D :D Yay!"> 
        <input placeholder="distance" name="distance" id="distance" style="visibility:hidden" > 
        <input placeholder="clerks" name="clerks" id="clerks" style="visibility:hidden">
    </form>
    <button id="botogameov"  class="butt1"  onclick="restart()"><h2><b>Skip and restart</b></h2></button>
</div>

<div id="gameover"> 
    <center>
    <h2><b>YOUR SWEET COPTER RIDE IS OVER :(</b></h2>
    </center>
</div> 

<div id="intro" >
    <b><p id="introtext"  > 
        </p></b>
    <center id="introbuttons">
        <button class='butt1' onclick='playsong();mou=true;requestAnimationFrame(move);document.getElementById("intro").innerHTML="";'><h1><b style='color:red'>YES</b></h1></button>
         <button onclick='caratrista()' class='butt1' ><h1><b>NO<b></h1></button>  
         <button class='butt1'  style='color:green' onclick='showranking()'><h1><b>Show Ranking<b></h1></button>
                                           </center>
    <button id="skipinbut" class='butt1' onclick='skipintrou()'><b>Skip intro</b></button>
</div>
<!-- galeria de songs a https://downloads.khinsider.com/game-soundtracks/album/fire-emblem-fates-->
</body>
</html>
